  // --- 库存盘点模块 ---

        function renderInventoryView() {
            const tbody = document.getElementById('inventory-table-body');
            const emptyMsg = document.getElementById('inventory-empty');
            const countElement = document.getElementById('inventory-count');
            tbody.innerHTML = '';
            
            // 过滤数据
            let displayData = [...inventoryData];
            const filter = currentFilter.inventory;
            
            if (filter.search) {
                const searchLower = filter.search.toLowerCase();
                displayData = displayData.filter(item => 
                    item.cargo.toLowerCase().includes(searchLower) || 
                    item.location.toLowerCase().includes(searchLower)
                );
            }
            
            if (filter.area) {
                displayData = displayData.filter(item => item.area === filter.area);
            }
            
            if (filter.status) {
                displayData = displayData.filter(item => item.status === filter.status);
            }
            
            // 更新统计信息
            const totalTypes = new Set(inventoryData.map(item => item.cargo)).size;
            const totalQty = inventoryData.reduce((sum, item) => sum + item.qty, 0);
            const lowStockCount = inventoryData.filter(item => item.status === '低库存').length;
            
            document.getElementById('stat-total-types').textContent = totalTypes;
            document.getElementById('stat-total-qty').textContent = totalQty.toLocaleString();
            document.getElementById('stat-location-usage').textContent = Math.floor(inventoryData.length / 100 * 100) + '%';
            document.getElementById('pending-count').textContent = inventoryData.filter(item => item.status === '待盘点').length;
            
            // 渲染表格
            if (displayData.length === 0) {
                emptyMsg.style.display = 'block';
                countElement.textContent = '0 条记录';
            } else {
                emptyMsg.style.display = 'none';
                countElement.textContent = `${displayData.length} 条记录`;
                
                displayData.forEach(item => {
                    let badgeClass = '';
                    switch(item.status) {
                        case '正常': badgeClass = 'bg-success'; break;
                        case '待盘点': badgeClass = 'bg-warning text-dark'; break;
                        case '低库存': badgeClass = 'bg-danger'; break;
                        case '过期': badgeClass = 'bg-secondary'; break;
                    }
                    
                    const isLowStock = item.qty < item.safeQty;
                    const qtyClass = isLowStock ? 'text-danger fw-bold' : '';

                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold">${item.id}</td>
                            <td>
                                <span class="badge bg-dark me-1">${item.area}</span>
                                ${item.location}
                            </td>
                            <td>${item.cargo}</td>
                            <td>${item.spec || '-'}</td>
                            <td class="${qtyClass}">${item.qty.toLocaleString()}</td>
                            <td>${item.safeQty.toLocaleString()}</td>
                            <td>${item.update}</td>
                            <td><span class="badge ${badgeClass}">${item.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-info me-1" onclick="adjustInventory('${item.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="stocktakeSingle('${item.id}')">
                                    <i class="fas fa-clipboard-check"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
        }

        function searchInventory() {
            currentFilter.inventory.search = document.getElementById('inventory-search').value;
            renderInventoryView();
        }

        function filterInventory() {
            currentFilter.inventory.area = document.getElementById('inventory-area').value;
            currentFilter.inventory.status = document.getElementById('inventory-status').value;
            renderInventoryView();
        }

        function resetInventoryFilters() {
            document.getElementById('inventory-search').value = '';
            document.getElementById('inventory-area').value = '';
            document.getElementById('inventory-status').value = '';
            currentFilter.inventory = { search: '', area: '', status: '' };
            renderInventoryView();
        }

        function startStocktake() {
            const type = document.getElementById('stocktake-type').value;
            const typeText = type === 'full' ? '全仓盘点' : type === 'area' ? '区域盘点' : '随机抽样';
            
            if(confirm(`确定要发起${typeText}任务吗？`)) {
                // 更新库存状态
                const locationsToStocktake = type === 'full' ? inventoryData : 
                                           type === 'area' ? inventoryData.filter(item => item.area === 'A') :
                                           inventoryData.filter(() => Math.random() > 0.7);
                
                locationsToStocktake.forEach(item => {
                    if (item.status !== '低库存' && item.status !== '过期') {
                        item.status = '待盘点';
                    }
                });
                
                setStorageData('wms_inventory_data', inventoryData);
                
                // 模拟设备调度
                showAlert(`正在调度四向穿梭车执行${typeText}任务...`, 'info');
                setTimeout(() => {
                    showAlert(`${typeText}任务已完成！`, 'success');
                    renderInventoryView();
                }, 2000);
            }
        }

        function showStocktakeHistory() {
            // 模拟盘点历史数据
            const historyData = [
                { id: 'ST2023120901', type: '全仓盘点', time: '2023-12-09 09:00', locations: 45, differences: 2, operator: 'admin', status: '已完成' },
                { id: 'ST2023120801', type: '随机抽样', time: '2023-12-08 14:30', locations: 12, differences: 0, operator: 'admin', status: '已完成' },
                { id: 'ST2023120501', type: '全仓盘点', time: '2023-12-05 08:00', locations: 50, differences: 3, operator: 'admin', status: '已完成' },
            ];
            
            const tbody = document.getElementById('stocktake-history-body');
            tbody.innerHTML = '';
            
            historyData.forEach(item => {
                const diffBadge = item.differences > 0 ? 
                    `<span class="badge bg-danger">${item.differences}</span>` : 
                    `<span class="badge bg-success">${item.differences}</span>`;
                    
                tbody.innerHTML += `
                    <tr>
                        <td>${item.id}</td>
                        <td>${item.type}</td>
                        <td>${item.time}</td>
                        <td>${item.locations}</td>
                        <td>${diffBadge}</td>
                        <td>${item.operator}</td>
                        <td><span class="badge bg-success">${item.status}</span></td>
                    </tr>
                `;
            });
            
            const modal = new bootstrap.Modal(document.getElementById('stocktakeHistoryModal'));
            modal.show();
        }

        function adjustInventory(invId) {
            const item = inventoryData.find(d => d.id === invId);
            if (!item) return;
            
            const newQty = prompt(`调整 ${item.cargo} (${item.location}) 的数量，当前: ${item.qty}`, item.qty);
            if (newQty && !isNaN(newQty) && parseInt(newQty) >= 0) {
                const oldQty = item.qty;
                item.qty = parseInt(newQty);
                item.update = new Date().toLocaleString('zh-CN');
                
                // 更新状态
                if (item.qty < item.safeQty) {
                    item.status = '低库存';
                } else if (item.status === '低库存') {
                    item.status = '正常';
                }
                
                setStorageData('wms_inventory_data', inventoryData);
                showAlert(`库存已调整: ${oldQty} → ${newQty}`, 'success');
                renderInventoryView();
            }
        }

        function stocktakeSingle(invId) {
            const item = inventoryData.find(d => d.id === invId);
            if (!item) return;
            
            const actualQty = prompt(`盘点 ${item.cargo} (${item.location})，账面数量: ${item.qty}，请输入实际数量:`, item.qty);
            if (actualQty && !isNaN(actualQty)) {
                const actual = parseInt(actualQty);
                const difference = actual - item.qty;
                
                if (difference === 0) {
                    item.status = '正常';
                    showAlert('盘点一致，无差异', 'success');
                } else {
                    item.qty = actual;
                    item.status = '正常';
                    const diffText = difference > 0 ? `盘盈 ${difference}` : `盘亏 ${Math.abs(difference)}`;
                    showAlert(`盘点完成，${diffText}`, difference > 0 ? 'success' : 'warning');
                }
                
                item.update = new Date().toLocaleString('zh-CN');
                setStorageData('wms_inventory_data', inventoryData);
                renderInventoryView();
            }
        }

        // --- 设备监控 ---

        function renderDeviceView() {
            // 设备状态已经在HTML中硬编码，这里可以添加动态更新逻辑
            // 在实际应用中，这里应该从服务器获取实时设备状态
        }

        function refreshDeviceStatus() {
            // 模拟刷新设备状态
            deviceData.forEach(device => {
                if (device.status === '运行中') {
                    device.battery = Math.max(10, device.battery - 1);
                } else if (device.status === '空闲') {
                    device.battery = Math.min(100, device.battery + 2);
                }
                device.lastUpdate = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            });
            
            setStorageData('wms_device_data', deviceData);
            showAlert('设备状态已刷新', 'success');
            
            // 这里应该更新UI，简化处理
            document.querySelectorAll('.card.border-success .badge').forEach(badge => {
                if (Math.random() > 0.8) {
                    badge.textContent = Math.random() > 0.5 ? '运行中' : '空闲';
                    badge.className = Math.random() > 0.5 ? 'badge bg-success' : 'badge bg-secondary';
                }
            });
        }

        function dispatchAGV(agvId) {
            showAlert(`正在调度 ${agvId} 执行搬运任务...`, 'info');
            setTimeout(() => {
                showAlert(`${agvId} 任务分配成功，正在前往B区`, 'success');
            }, 1500);
        }

        function stopAGV(agvId) {
            if(confirm(`确定要停止 ${agvId} 吗？`)) {
                showAlert(`${agvId} 已停止`, 'warning');
            }
        }

        function startShuttleTask() {
            showAlert('四向穿梭车开始执行盘点任务...', 'info');
            setTimeout(() => {
                showAlert('盘点任务进行中，已完成 30%', 'info');
                setTimeout(() => {
                    showAlert('盘点任务完成，未发现差异', 'success');
                }, 3000);
            }, 2000);
        }

        function pauseShuttle() {
            showAlert('已暂停穿梭车当前任务', 'warning');
        }

        function showDeviceLogs() {
            alert('设备日志功能开发中...\n\nAGV-001: 2023-12-09 13:45 执行搬运任务\nAGV-002: 2023-12-09 13:30 进入充电站\nShuttle-01: 2023-12-09 13:50 开始A区盘点');
        }

        // --- 出库订单管理 ---

        function renderOrdersView() {
            const tbody = document.getElementById('orders-table-body');
            const emptyMsg = document.getElementById('orders-empty');
            tbody.innerHTML = '';
            
            // 过滤数据
            let displayData = [...orderData];
            
            if (currentFilter.orders !== 'all') {
                const statusMap = {
                    'pending': '待拣选',
                    'picking': '拣货中',
                    'shipped': '已发货',
                    'completed': '已完成'
                };
                displayData = displayData.filter(item => item.status === statusMap[currentFilter.orders]);
            }
            
            // 渲染表格
            if (displayData.length === 0) {
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
                displayData.forEach(item => {
                    let badgeClass = '';
                    switch(item.status) {
                        case '已完成': badgeClass = 'bg-success'; break;
                        case '待拣选': badgeClass = 'bg-warning text-dark'; break;
                        case '拣货中': badgeClass = 'bg-info'; break;
                        case '已发货': badgeClass = 'bg-primary'; break;
                        case '已取消': badgeClass = 'bg-secondary'; break;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold">${item.id}</td>
                            <td>${item.customer}</td>
                            <td>${item.items} 种</td>
                            <td>${item.totalQty.toLocaleString()}</td>
                            <td><span class="badge ${badgeClass}">${item.status}</span></td>
                            <td>${item.time}</td>
                            <td>${item.shipDate || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white me-1" onclick="viewOrderDetail('${item.id}')">
                                    <i class="fas fa-search"></i>
                                </button>
                                ${item.status === '待拣选' || item.status === '拣货中' ? `
                                <button class="btn btn-sm btn-primary me-1" onclick="processOrder('${item.id}')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="cancelOrder('${item.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
            }
        }

        function filterOrders(filter) {
            currentFilter.orders = filter;
            renderOrdersView();
        }

        function showCreateOrderModal() {
            const modal = new bootstrap.Modal(document.getElementById('createOrderModal'));
            modal.show();
        }

        function addOrderItem() {
            const container = document.getElementById('order-items-container');
            const newItem = document.createElement('div');
            newItem.className = 'order-item row g-3 mb-2 align-items-end';
            newItem.innerHTML = `
                <div class="col-md-5">
                    <label class="form-label small">货物名称</label>
                    <input type="text" class="form-control form-control-sm" placeholder="选择货物">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">数量</label>
                    <input type="number" class="form-control form-control-sm" placeholder="数量" min="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">单位</label>
                    <select class="form-select form-select-sm">
                        <option>件</option>
                        <option>箱</option>
                        <option>个</option>
                        <option>套</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItem(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            container.appendChild(newItem);
        }

        function removeOrderItem(button) {
            const itemDiv = button.closest('.order-item');
            if (itemDiv && document.querySelectorAll('.order-item').length > 1) {
                itemDiv.remove();
            } else {
                showAlert('至少需要保留一个订单项', 'warning');
            }
        }

        function confirmCreateOrder() {
            const customer = document.getElementById('order-customer').value.trim();
            const type = document.getElementById('order-type').value;
            const shipDate = document.getElementById('order-ship-date').value;
            const address = document.getElementById('order-address').value.trim();
            const notes = document.getElementById('order-notes').value.trim();
            
            if (!customer) {
                showAlert('请填写客户名称！', 'warning');
                return;
            }
            
            const newId = 'OUT' + new Date().getTime().toString().slice(-8);
            const now = new Date();
            const timeStr = now.toLocaleDateString('zh-CN') + ' ' + now.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            
            // 模拟计算货物种类和总数
            const itemCount = document.querySelectorAll('.order-item').length;
            const totalQty = Array.from(document.querySelectorAll('.order-item input[type="number"]'))
                .reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            
            orderData.unshift({
                id: newId,
                customer: customer,
                type: type,
                items: itemCount,
                totalQty: totalQty || 100,
                status: '待拣选',
                time: timeStr,
                shipDate: shipDate || now.toISOString().split('T')[0],
                address: address || '未填写地址',
                notes: notes,
                auditLog: []
            });
            
            setStorageData('wms_order_data', orderData);
            
            bootstrap.Modal.getInstance(document.getElementById('createOrderModal')).hide();
            
            showAlert(`已成功创建订单 ${newId}，正在进行货物分配与路径规划。`, 'success');
            renderOrdersView();
            refreshDashboard(); // 更新仪表板数据
        }

        function viewOrderDetail(orderId) {
            const order = orderData.find(o => o.id === orderId);
            if (!order) return;
            
            let detail = `订单编号: ${order.id}\n`;
            detail += `客户: ${order.customer}\n`;
            detail += `类型: ${order.type}\n`;
            detail += `货物种类: ${order.items} 种\n`;
            detail += `总数量: ${order.totalQty}\n`;
            detail += `状态: ${order.status}\n`;
            detail += `创建时间: ${order.time}\n`;
            detail += `预计发货: ${order.shipDate || '未设置'}\n`;
            detail += `收货地址: ${order.address}\n`;
            detail += `备注: ${order.notes || '无'}\n\n`;
            
            if (order.auditLog && order.auditLog.length > 0) {
                detail += '操作记录:\n';
                order.auditLog.forEach(log => {
                    detail += `  ${log.time} ${log.user} ${log.action}\n`;
                });
            }
            
            alert(detail);
        }

        function processOrder(orderId) {
            const order = orderData.find(o => o.id === orderId);
            if (!order) return;
            
            const nextStatus = order.status === '待拣选' ? '拣货中' : 
                             order.status === '拣货中' ? '已发货' :
                             order.status === '已发货' ? '已完成' : order.status;
            
            const now = new Date();
            const timeStr = now.toLocaleDateString('zh-CN') + ' ' + now.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            
            order.status = nextStatus;
            order.auditLog.push({
                user: currentUser.name,
                action: nextStatus,
                time: timeStr
            });
            
            setStorageData('wms_order_data', orderData);
            
            const actionText = nextStatus === '拣货中' ? '开始拣货' : 
                             nextStatus === '已发货' ? '标记发货' : '标记完成';
            showAlert(`订单 ${orderId} ${actionText}成功！`, 'success');
            
            renderOrdersView();
            refreshDashboard(); // 更新仪表板数据
        }

        function cancelOrder(orderId) {
            const order = orderData.find(o => o.id === orderId);
            if (!order) return;
            
            if(confirm(`确定要取消订单 ${orderId} 吗？`)) {
                order.status = '已取消';
                const now = new Date();
                const timeStr = now.toLocaleDateString('zh-CN') + ' ' + now.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
                
                order.auditLog.push({
                    user: currentUser.name,
                    action: '取消',
                    time: timeStr
                });
                
                setStorageData('wms_order_data', orderData);
                showAlert(`订单 ${orderId} 已取消。`, 'success');
                renderOrdersView();
                refreshDashboard();
            }
        }

        // --- 页面初始化 ---
        window.addEventListener('load', function() {
            // 设置默认日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cargo-eta').value = today;
            document.getElementById('order-ship-date').value = today;
            
            // 初始化数据存储
            if (!localStorage.getItem('wms_inbound_data')) {
                setStorageData('wms_inbound_data', inboundData);
            }
            if (!localStorage.getItem('wms_inventory_data')) {
                setStorageData('wms_inventory_data', inventoryData);
            }
            if (!localStorage.getItem('wms_order_data')) {
                setStorageData('wms_order_data', orderData);
            }
            if (!localStorage.getItem('wms_device_data')) {
                setStorageData('wms_device_data', deviceData);
            }
        });

    </script>
</body>
</html>